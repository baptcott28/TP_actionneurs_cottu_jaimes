/**
 * \file motor_cmd.c
 * \brief Fichier contenant les fonctions de gestion du moteur
 * \date 25/10/2022*
 *
 * \author Baptiste Cottu , Diego jaimes
 */

#include "motor_cmd.h"
#include "main.h"

#define SPEED_MAX 1740

extern TIM_HandleTypeDef htim1;
extern TIM_HandleTypeDef htim2;

extern uint8_t speed[SPEED_MAX_DIGIT];

/**
 * \fn void motor_start(void)
 * \brief Démarre le timer 2 et met la Pin ISO_RESET a 1 pendant le temps requis. Le reset de ISO_RESET se fait dans l'interruption de tim2
 */
void motor_start(void){
	HAL_TIM_Base_Start_IT(&htim2);
	HAL_GPIO_WritePin(ISO_RESET_GPIO_Port,ISO_RESET_Pin,1);
}

/**
 * \fn void motor_set_speed(void)
 * \brief Récupère et traite la commande de vitesse du moteur
 */
void motor_set_speed(uint8_t speed[]){
	int res=0;
	for(int i=0;i<SPEED_MAX_DIGIT+1;i++){
		res=res+speed[i]*(10**(SPEED_MAX_DIGIT-i-1));
	}
	printf("res : %d",res);
	if(res>SPEED_MAX){
		res=SPEED_MAX;
	}
	TIM1->CCR1=res;
	TIM1->CCR2=1750-res;
}
